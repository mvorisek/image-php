name: CI

on:
  pull_request:
  push:
  schedule:
    - cron: '20 2 1,15 * *'

jobs:
  unit:
    name: Templating
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/mvorisek/image-php
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: "Check if files are in-sync"
        run: |
          rm -rf data/
          php make.php
          git add . -N && git diff --exit-code

  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      REGISTRY_NAME: ghcr.io
      REGISTRY_IMAGE_NAME: ghcr.io/${{ github.repository }}
    strategy:
      fail-fast: false
      matrix:
        imageName:
          - "8.2-alpine"
          - "8.2-zts-alpine"
          - "8.2-debug-alpine"
          - "8.3-alpine"
          - "8.3-zts-alpine"
          - "8.3-debug-alpine"
          - "8.2-debian"
          - "8.2-zts-debian"
          - "8.2-debug-debian"
          - "8.3-debian"
          - "8.3-zts-debian"
          - "8.3-debug-debian"
    steps:
      - name: Checkout
        uses: actions/checkout@v3



      - name: 'Target "basic" - build'
        # try to build twice to suppress random network issues with Github Actions
        run: >-
          sed -i 's~^[ \t]*~~' data/${{ matrix.imageName }}/Dockerfile
          && (docker build -f data/${{ matrix.imageName }}/Dockerfile --target "basic" -t "ci-target:basic" ./
          || docker build -f data/${{ matrix.imageName }}/Dockerfile --target "basic" -t "ci-target:basic" ./)

      - name: 'Target "basic" - test'
        # try to build twice to suppress random network issues with Github Actions
        run: >-
          sed -i 's~^[ \t]*~~' data/${{ matrix.imageName }}/Dockerfile
          && (docker build -f data/${{ matrix.imageName }}/Dockerfile --target "basic__test" -t "ci-target:basic__test" ./
          || docker build -f data/${{ matrix.imageName }}/Dockerfile --target "basic__test" -t "ci-target:basic__test" ./)

      - name: 'Target "basic" - display layer sizes'
        run: >-
          docker history --no-trunc --format "table {{.CreatedSince}}\t{{.Size}}\t{{.CreatedBy}}" $(docker inspect --format="{{.Id}}" "ci-target:basic")
          && docker images --no-trunc --format "Total size: {{.Size}}\t{{.ID}}" | grep $(docker inspect --format="{{.Id}}" "ci-target:basic") | cut -f1

      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY_NAME }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Push tags to registry - 8.2.x'
        if: (github.ref == 'refs/heads/master') && (matrix.imageName == '8.2-alpine' || matrix.imageName == '8.2-zts-alpine' || matrix.imageName == '8.2-debug-alpine' || matrix.imageName == '8.2-debian' || matrix.imageName == '8.2-zts-debian' || matrix.imageName == '8.2-debug-debian')
        run: >-
          dtp() { docker tag "ci-target:$1" "$REGISTRY_IMAGE_NAME:$2" && docker push "$REGISTRY_IMAGE_NAME:$2"; }
          && if [ "${{ matrix.imageName }}" == "8.2-alpine" ]; then
          dtp "base" "8.2-base"
          && dtp "base" "8.2-alpine-base"
          && dtp "basic" "8.2"
          && dtp "basic" "8.2-alpine"
          ; elif [ "${{ matrix.imageName }}" == "8.2-zts-alpine" ]; then
          dtp "base" "8.2-zts-base"
          && dtp "base" "8.2-zts-alpine-base"
          && dtp "basic" "8.2-zts"
          && dtp "basic" "8.2-zts-alpine"
          ; elif [ "${{ matrix.imageName }}" == "8.2-debug-alpine" ]; then
          dtp "base" "8.2-debug-base"
          && dtp "base" "8.2-debug-alpine-base"
          && dtp "basic" "8.2-debug"
          && dtp "basic" "8.2-debug-alpine"
          ; elif [ "${{ matrix.imageName }}" == "8.2-debian" ]; then
          dtp "base" "8.2-debian-base"
          && dtp "basic" "8.2-debian"
          ; elif [ "${{ matrix.imageName }}" == "8.2-zts-debian" ]; then
          dtp "base" "8.2-zts-debian-base"
          && dtp "basic" "8.2-zts-debian"
          ; elif [ "${{ matrix.imageName }}" == "8.2-debug-debian" ]; then
          dtp "base" "8.2-debug-debian-base"
          && dtp "basic" "8.2-debug-debian"
          ; fi

      - name: 'Push tags to registry - 8.3.x'
        if: (github.ref == 'refs/heads/master') && (matrix.imageName == '8.3-alpine' || matrix.imageName == '8.3-zts-alpine' || matrix.imageName == '8.3-debug-alpine' || matrix.imageName == '8.3-debian' || matrix.imageName == '8.3-zts-debian' || matrix.imageName == '8.3-debug-debian')
        run: >-
          dtp() { docker tag "ci-target:$1" "$REGISTRY_IMAGE_NAME:$2" && docker push "$REGISTRY_IMAGE_NAME:$2"; }
          && if [ "${{ matrix.imageName }}" == "8.3-alpine" ]; then
          dtp "base" "8.3-base"
          && dtp "base" "8.3-alpine-base"
          && dtp "basic" "8.3"
          && dtp "basic" "8.3-alpine"
          ; elif [ "${{ matrix.imageName }}" == "8.3-zts-alpine" ]; then
          dtp "base" "8.3-zts-base"
          && dtp "base" "8.3-zts-alpine-base"
          && dtp "basic" "8.3-zts"
          && dtp "basic" "8.3-zts-alpine"
          ; elif [ "${{ matrix.imageName }}" == "8.3-debug-alpine" ]; then
          dtp "base" "8.3-debug-base"
          && dtp "base" "8.3-debug-alpine-base"
          && dtp "basic" "8.3-debug"
          && dtp "basic" "8.3-debug-alpine"
          ; elif [ "${{ matrix.imageName }}" == "8.3-debian" ]; then
          dtp "base" "8.3-debian-base"
          && dtp "basic" "8.3-debian"
          ; elif [ "${{ matrix.imageName }}" == "8.3-zts-debian" ]; then
          dtp "base" "8.3-zts-debian-base"
          && dtp "basic" "8.3-zts-debian"
          ; elif [ "${{ matrix.imageName }}" == "8.3-debug-debian" ]; then
          dtp "base" "8.3-debug-debian-base"
          && dtp "basic" "8.3-debug-debian"
          ; fi
